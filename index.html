<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>每月流水記錄</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--primary:#2563eb;--bg:#f4f4f5;--card-bg:#fff;--border:#e5e7eb;--text-main:#111827;--text-sub:#6b7280;--danger:#b91c1c;}
    *{box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,"Microsoft JhengHei",sans-serif;margin:0;background:var(--bg);color:var(--text-main);}
    header{padding:16px 12px 8px;max-width:520px;margin:0 auto;}
    h1{font-size:20px;margin:0 0 4px;text-align:center;}
    .subtitle{font-size:12px;color:var(--text-sub);text-align:center;}
    .top-summary{max-width:520px;margin:8px auto 0;padding:8px 12px 0;font-size:13px;color:var(--text-sub);line-height:1.6;}
    main{max-width:520px;margin:0 auto;padding:8px 12px 90px;}
    .card{background:var(--card-bg);border-radius:12px;padding:10px 10px 12px;margin-bottom:10px;border:1px solid var(--border);}
    .card-title{font-size:13px;font-weight:700;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
    .card-title span.sub{font-size:11px;color:var(--text-sub);font-weight:500;}
    label{display:block;margin-top:8px;font-size:12px;font-weight:700;}
    input{margin-top:4px;padding:10px 10px;width:100%;border-radius:10px;border:1px solid var(--border);font-size:14px;background:#fff;}
    .row{display:flex;gap:10px;}
    .row>.col{flex:1;}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px;}
    th,td{border:1px solid var(--border);padding:6px;text-align:center;}
    th{background:#f9fafb;font-weight:800;}
    .btn{margin-top:10px;padding:10px 14px;cursor:pointer;border-radius:999px;border:none;font-size:14px;font-weight:800;}
    .btn-primary{background:var(--primary);color:#fff;}
    .btn-secondary{background:#e5e7eb;color:#111827;}
    .btn-small{padding:6px 10px;font-size:12px;border-radius:999px;border:1px solid #d1d5db;background:#f9fafb;cursor:pointer;}
    .btn-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
    .msg{margin-top:8px;min-height:1.4em;font-size:12px;color:var(--text-sub);line-height:1.4;}
    .msg.error{color:var(--danger);}
    .checkbox-inline{display:flex;align-items:center;gap:6px;margin-top:10px;font-size:12px;color:var(--text-sub);}
    .checkbox-inline input[type="checkbox"]{width:auto;margin-top:0;}
    .tab-page{display:none;}
    .tab-page.active{display:block;}
    .bottom-nav-wrapper{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:center;pointer-events:none;}
    .bottom-nav{pointer-events:auto;max-width:520px;width:100%;background:#fff;border-top:1px solid var(--border);box-shadow:0 -2px 10px rgba(0,0,0,.08);display:flex;padding:10px 8px 14px;gap:8px;}
    .tab-btn{flex:1;padding:10px 8px;font-size:13px;border-radius:999px;border:1px solid transparent;background:transparent;cursor:pointer;color:var(--text-sub);font-weight:800;}
    .tab-btn.active{background:#e0edff;color:#1d4ed8;border-color:#bfdbfe;}
    .hint{font-size:12px;color:var(--text-sub);line-height:1.6;}
    .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
    .kpi .box{flex:1;min-width:140px;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff;}
    .kpi .box .t{font-size:11px;color:var(--text-sub);font-weight:700;}
    .kpi .box .v{font-size:18px;font-weight:900;margin-top:6px;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;}
  </style>
</head>
<body>
  <header>
    <h1>每月流水記錄</h1>
    <div class="subtitle">手機版 · 收入 / 支出 / 固定支出 / 總計</div>
  </header>

  <div class="top-summary">
    下方頁籤切換頁面：先輸入收入與支出，再到「固定支出」設定訂閱，最後到「總計」查看並存檔當月彙總。<br/>
    若支出有分期：請在「支出」頁籤輸入總金額與分期期數。
  </div>

  <main>
    <!-- 收入 -->
    <div class="tab-page active" id="tab-income">
      <div class="card">
        <div class="card-title"><span>新增收入</span><span class="sub">可同月多筆入帳</span></div>

        <div class="row">
          <div class="col">
            <label>日期
              <input type="date" id="incomeDate">
            </label>
          </div>
          <div class="col">
            <label>金額
              <input type="number" id="incomeAmount" placeholder="例如 30000">
            </label>
          </div>
        </div>

        <label>備註（選填）
          <input type="text" id="incomeNote" placeholder="例如：正職薪水 / 獎金">
        </label>

        <div class="btn-row">
          <button class="btn btn-primary" id="addIncomeBtn">新增收入</button>
          <button class="btn btn-secondary" id="cancelIncomeEditBtn" style="display:none;">取消編輯</button>
        </div>
        <div class="msg" id="incomeMsg"></div>
      </div>

      <div class="card">
        <div class="card-title"><span>收入列表（同步試算表）</span><span class="sub">重新整理也會保留</span></div>
        <div class="btn-row">
          <button class="btn btn-secondary" id="reloadIncomeBtn">重新讀取收入</button>
        </div>
        <table>
          <thead><tr><th>日期</th><th>金額</th><th>備註</th><th></th></tr></thead>
          <tbody id="incomeTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- 支出（含分期） -->
    <div class="tab-page" id="tab-expense">
      <div class="card">
        <div class="card-title"><span>新增支出</span><span class="sub">一般支出 / 分期支出</span></div>

        <div class="row">
          <div class="col">
            <label>日期
              <input type="date" id="expDate">
            </label>
          </div>
          <div class="col">
            <label>金額
              <input type="number" id="expAmount" placeholder="例如 1200（分期請填總金額）">
            </label>
          </div>
        </div>

        <label>備註（選填）
          <input type="text" id="expNote" placeholder="例如：餐費 / 交通 / 生活用品 / 信貸">
        </label>

        <div class="row">
          <div class="col">
            <label>分期期數（選填）
              <input type="number" id="expInstallTerms" placeholder="例如 6（不分期就留空）">
            </label>
          </div>
          <div class="col">
            <label>每期金額（自動）
              <input type="text" id="expPerTerm" placeholder="自動計算" disabled>
            </label>
          </div>
        </div>

        <div class="hint">
          分期規則：輸入總金額 12000、分 6 期 → 本月先扣 2000，並建立分期清單：剩餘 10000、剩餘 5 期。<br/>
          後續月份分期扣款會在你「存檔到試算表（流水彙總）」時自動套用，避免重算就重複扣款。
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="addExpenseBtn">新增支出</button>
          <button class="btn btn-secondary" id="cancelExpenseEditBtn" style="display:none;">取消編輯</button>
        </div>
        <div class="msg" id="expMsg"></div>
      </div>

      <div class="card">
        <div class="card-title"><span>支出列表（同步試算表）</span><span class="sub">可編輯/刪除</span></div>
        <div class="btn-row">
          <button class="btn btn-secondary" id="reloadExpenseBtn">重新讀取支出</button>
        </div>
        <table>
          <thead><tr><th>日期</th><th>金額</th><th>備註</th><th>類型</th><th></th></tr></thead>
          <tbody id="expTableBody"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="card-title"><span>分期清單（同步試算表）</span><span class="sub">顯示用</span></div>
        <div class="btn-row">
          <button class="btn btn-secondary" id="reloadInstallBtn">重新讀取分期清單</button>
        </div>
        <table>
          <thead><tr><th>名稱/備註</th><th>總額</th><th>每期</th><th>剩餘</th><th>剩餘期數</th><th>狀態</th></tr></thead>
          <tbody id="installTableBody"></tbody>
        </table>
        <div class="msg" id="installMsg"></div>
      </div>
    </div>

    <!-- 固定支出 -->
    <div class="tab-page" id="tab-fixed">
      <div class="card">
        <div class="card-title"><span>其他固定支出</span><span class="sub">房租、保險、貸款等總額</span></div>
        <label>每月其他固定支出總額
          <input type="number" id="otherFixedAmount" placeholder="例如：房租 + 保險 + 車貸">
        </label>
        <div class="btn-row">
          <button class="btn btn-primary" id="saveOtherFixedBtn">儲存固定支出設定</button>
        </div>
        <div class="msg" id="otherFixedMsg"></div>
      </div>

      <div class="card">
        <div class="card-title"><span>訂閱清單</span><span class="sub">（維持你原本 OK 的功能）</span></div>

        <div class="btn-row">
          <button class="btn btn-secondary" id="reloadSubBtn">重新讀取訂閱</button>
        </div>

        <div class="row">
          <div class="col"><label>訂閱名稱<input type="text" id="subName" placeholder="例如：Netflix"></label></div>
          <div class="col"><label>月費<input type="number" id="subAmount" placeholder="例如 390"></label></div>
        </div>

        <div class="checkbox-inline">
          <input type="checkbox" id="subActive" checked>
          <label for="subActive">啟用（計入固定支出）</label>
        </div>

        <div class="btn-row">
          <button class="btn btn-secondary" id="clearSubFormBtn">清空表單</button>
          <button class="btn btn-primary" id="saveSubBtn">新增訂閱</button>
        </div>

        <div class="msg" id="subMsg"></div>

        <table>
          <thead><tr><th>名稱</th><th>月費</th><th>啟用</th><th></th></tr></thead>
          <tbody id="subTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- 總計 -->
    <div class="tab-page" id="tab-summary">
      <div class="card">
        <div class="card-title"><span>總計</span><span class="sub">自動更新（也可手動重算）</span></div>

        <div class="row">
          <div class="col">
            <label>月份（YYYY-MM）
              <input type="month" id="summaryMonth">
            </label>
          </div>
          <div class="col">
            <div class="btn-row" style="margin-top:18px">
              <button class="btn btn-secondary" id="recalcBtn">重新計算</button>
            </div>
          </div>
        </div>

        <div class="kpi">
          <div class="box"><div class="t">收入合計</div><div class="v mono" id="kIncome">0</div></div>
          <div class="box"><div class="t">一般支出合計</div><div class="v mono" id="kExpense">0</div></div>
          <div class="box"><div class="t">分期本月扣款</div><div class="v mono" id="kInstall">0</div></div>
          <div class="box"><div class="t">固定支出（其他+訂閱）</div><div class="v mono" id="kFixed">0</div></div>
          <div class="box"><div class="t">本月餘額</div><div class="v mono" id="kRemain">0</div></div>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="saveMonthlySummaryBtn">存檔到試算表（流水彙總）</button>
        </div>

        <div class="msg" id="sumMsg"></div>
      </div>

      <div class="card">
        <div class="card-title"><span>本月明細（顯示用）</span><span class="sub">便於核對</span></div>
        <div class="hint" id="sumDetail"></div>
      </div>
    </div>
  </main>

  <div class="bottom-nav-wrapper">
    <nav class="bottom-nav">
      <button class="tab-btn active" data-tab="income">收入</button>
      <button class="tab-btn" data-tab="expense">支出</button>
      <button class="tab-btn" data-tab="fixed">固定支出</button>
      <button class="tab-btn" data-tab="summary">總計</button>
    </nav>
  </div>

<script>
  // ✅ 你的 Apps Script Web App /exec
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxLEufK5CDeb3_Yykh_GxaR524eoYodeeFSgS-vouQP-UNSRwbrxdRJ4CkOYZOcpJnD/exec';

  // === JSONP（GitHub Pages 跨網域用）===
  function jsonpGet(params) {
    return new Promise((resolve, reject) => {
      const callbackName = '__cb_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
      params = params || {};
      params.callback = callbackName;

      const qs = new URLSearchParams(params).toString();
      const url = SCRIPT_URL + '?' + qs;

      const script = document.createElement('script');
      script.src = url;
      script.async = true;

      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error('JSONP timeout'));
      }, 12000);

      function cleanup() {
        clearTimeout(timeout);
        try { delete window[callbackName]; } catch(_) {}
        script.remove();
      }

      window[callbackName] = (data) => {
        cleanup();
        resolve(data);
      };

      script.onerror = () => {
        cleanup();
        reject(new Error('JSONP load error'));
      };

      document.body.appendChild(script);
    });
  }

  // 訂閱維持你既有：POST no-cors
  function postForm(dataObj) {
    const form = new URLSearchParams();
    Object.keys(dataObj).forEach(k => form.append(k, dataObj[k]));
    return fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: form });
  }

  function fmt(n){
    const x = Number(n)||0;
    return x.toLocaleString('zh-TW');
  }

  function ymdToDisplay(ymd){
    // ymd: yyyy-mm-dd
    if (!ymd) return '';
    const m = String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return String(ymd);
    return `${Number(m[1])}/${Number(m[2])}/${Number(m[3])}`;
  }

  function monthOfDate(ymd){
    const m = String(ymd||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return '';
    return `${m[1]}-${m[2]}`;
  }

  // === TAB ===
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabPages = document.querySelectorAll('.tab-page');
  tabBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const target = btn.dataset.tab;
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPages.forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + target).classList.add('active');

      if (target === 'summary') {
        ensureSummaryMonth();
        autoRecalc();
      }
    });
  });

  // =========================================================
  // 收入（讀取/新增/編輯/刪除）
  // =========================================================
  let incomes = []; // {recordId,date,amount,note,month}
  let editingIncomeRecordId = null;

  const incomeDateInput = document.getElementById('incomeDate');
  const incomeAmountInput = document.getElementById('incomeAmount');
  const incomeNoteInput = document.getElementById('incomeNote');
  const incomeMsg = document.getElementById('incomeMsg');
  const incomeTableBody = document.getElementById('incomeTableBody');
  const cancelIncomeEditBtn = document.getElementById('cancelIncomeEditBtn');

  document.getElementById('reloadIncomeBtn').addEventListener('click', loadIncomeFromSheet);

  cancelIncomeEditBtn.addEventListener('click', ()=>{
    editingIncomeRecordId = null;
    incomeDateInput.value = '';
    incomeAmountInput.value = '';
    incomeNoteInput.value = '';
    document.getElementById('addIncomeBtn').textContent = '新增收入';
    cancelIncomeEditBtn.style.display = 'none';
    incomeMsg.textContent = '';
    incomeMsg.classList.remove('error');
  });

  document.getElementById('addIncomeBtn').addEventListener('click', async () => {
    const date = incomeDateInput.value;
    const amount = Number(incomeAmountInput.value) || 0;
    const note = incomeNoteInput.value.trim();

    incomeMsg.classList.remove('error');
    if (!date || !amount) {
      incomeMsg.textContent = '請輸入收入日期與金額';
      incomeMsg.classList.add('error');
      return;
    }

    incomeMsg.textContent = editingIncomeRecordId ? '更新中...' : '寫入中...';

    try {
      let res;
      if (editingIncomeRecordId) {
        res = await jsonpGet({ type: 'updateIncome', recordId: editingIncomeRecordId, date, amount: String(amount), note });
      } else {
        res = await jsonpGet({ type: 'addIncome', date, amount: String(amount), note });
      }
      if (!res || !res.success) throw new Error((res && res.error) ? res.error : '操作失敗');

      await loadIncomeFromSheet();
      editingIncomeRecordId = null;
      document.getElementById('addIncomeBtn').textContent = '新增收入';
      cancelIncomeEditBtn.style.display = 'none';

      incomeDateInput.value = '';
      incomeAmountInput.value = '';
      incomeNoteInput.value = '';
      incomeMsg.textContent = '已同步到試算表。';

      autoRecalc();
    } catch (e) {
      incomeMsg.textContent = '失敗：' + e.message;
      incomeMsg.classList.add('error');
    }
  });

  async function loadIncomeFromSheet(){
    incomeMsg.classList.remove('error');
    incomeMsg.textContent = '讀取收入中...';
    try{
      const res = await jsonpGet({ type:'listIncome' });
      if (!res || !res.success) throw new Error((res && res.error) ? res.error : '讀取失敗');
      incomes = (res.data || []).map(x => ({
        recordId: x.recordId,
        date: x.date,
        month: x.month,
        amount: Number(x.amount||0),
        note: x.note || ''
      }));
      renderIncomeTable();
      incomeMsg.textContent = `已讀取 ${incomes.length} 筆收入。`;
    }catch(e){
      incomeMsg.textContent = '讀取失敗：' + e.message;
      incomeMsg.classList.add('error');
    }
  }

  function renderIncomeTable() {
    incomeTableBody.innerHTML = '';
    incomes.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ymdToDisplay(item.date)}</td>
        <td>${fmt(item.amount)}</td>
        <td>${item.note || ''}</td>
        <td>
          <button class="btn-small income-edit" data-id="${item.recordId}">編輯</button>
          <button class="btn-small income-del" data-id="${item.recordId}">刪除</button>
        </td>
      `;
      incomeTableBody.appendChild(tr);
    });

    incomeTableBody.querySelectorAll('.income-edit').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id;
        const item = incomes.find(x => x.recordId === id);
        if (!item) return;
        editingIncomeRecordId = id;
        incomeDateInput.value = item.date;
        incomeAmountInput.value = String(item.amount);
        incomeNoteInput.value = item.note || '';
        document.getElementById('addIncomeBtn').textContent = '更新收入';
        cancelIncomeEditBtn.style.display = 'inline-block';
        incomeMsg.textContent = '編輯模式：修改後按「更新收入」。';
        incomeMsg.classList.remove('error');

        // 自動把總計月份切到該筆月份
        setSummaryMonthIfEmpty(item.month);
      });
    });

    incomeTableBody.querySelectorAll('.income-del').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        if (!confirm('確定要刪除此筆收入，並同步刪除試算表資料嗎？')) return;

        incomeMsg.classList.remove('error');
        incomeMsg.textContent = '刪除中...';

        try {
          const res = await jsonpGet({ type: 'deleteIncome', recordId: id });
          if (!res || !res.success) throw new Error((res && res.error) ? res.error : '刪除失敗');
          await loadIncomeFromSheet();
          incomeMsg.textContent = '已同步刪除試算表資料。';
          autoRecalc();
        } catch (e) {
          incomeMsg.textContent = '刪除失敗：' + e.message;
          incomeMsg.classList.add('error');
        }
      });
    });
  }

  // =========================================================
  // 支出（讀取/新增/編輯/刪除） + 分期清單
  // =========================================================
  let expenses = []; // {recordId,date,amount,note,kind,terms}
  let editingExpenseRecordId = null;

  const expDate = document.getElementById('expDate');
  const expAmount = document.getElementById('expAmount');
  const expNote = document.getElementById('expNote');
  const expInstallTerms = document.getElementById('expInstallTerms');
  const expPerTerm = document.getElementById('expPerTerm');
  const expMsg = document.getElementById('expMsg');
  const expTableBody = document.getElementById('expTableBody');
  const cancelExpenseEditBtn = document.getElementById('cancelExpenseEditBtn');

  document.getElementById('reloadExpenseBtn').addEventListener('click', loadExpenseFromSheet);

  cancelExpenseEditBtn.addEventListener('click', ()=>{
    editingExpenseRecordId = null;
    expDate.value = '';
    expAmount.value = '';
    expNote.value = '';
    expInstallTerms.value = '';
    expPerTerm.value = '';
    document.getElementById('addExpenseBtn').textContent = '新增支出';
    cancelExpenseEditBtn.style.display = 'none';
    expMsg.textContent = '';
    expMsg.classList.remove('error');
  });

  expInstallTerms.addEventListener('input', () => {
    const a = Number(expAmount.value)||0;
    const t = Number(expInstallTerms.value)||0;
    if (a > 0 && t > 1) expPerTerm.value = String(Math.round(a / t));
    else expPerTerm.value = '';
  });
  expAmount.addEventListener('input', () => {
    const a = Number(expAmount.value)||0;
    const t = Number(expInstallTerms.value)||0;
    if (a > 0 && t > 1) expPerTerm.value = String(Math.round(a / t));
    else expPerTerm.value = '';
  });

  document.getElementById('addExpenseBtn').addEventListener('click', async () => {
    const date = expDate.value;
    const amount = Number(expAmount.value)||0;
    const note = expNote.value.trim();
    const terms = Number(expInstallTerms.value)||0;

    expMsg.classList.remove('error');
    if (!date || !amount) {
      expMsg.textContent = '請輸入支出日期與金額';
      expMsg.classList.add('error');
      return;
    }

    // 編輯模式：不允許改分期（避免破壞分期資料），只改日期/金額/備註
    if (editingExpenseRecordId) {
      expMsg.textContent = '更新中...';
      try{
        const res = await jsonpGet({
          type:'updateExpense',
          recordId: editingExpenseRecordId,
          date,
          amount: String(amount),
          note
        });
        if (!res || !res.success) throw new Error((res && res.error) ? res.error : '更新失敗');

        await loadExpenseFromSheet();
        editingExpenseRecordId = null;
        document.getElementById('addExpenseBtn').textContent = '新增支出';
        cancelExpenseEditBtn.style.display = 'none';

        expDate.value = '';
        expAmount.value = '';
        expNote.value = '';
        expInstallTerms.value = '';
        expPerTerm.value = '';
        expMsg.textContent = '已更新並同步試算表。';
        autoRecalc();
      }catch(e){
        expMsg.textContent = '更新失敗：' + e.message;
        expMsg.classList.add('error');
      }
      return;
    }

    expMsg.textContent = '寫入中...';

    try {
      const res = await jsonpGet({
        type: 'addExpense',
        date,
        amount: String(amount),
        note,
        terms: String(terms||0)
      });
      if (!res || !res.success) throw new Error((res && res.error) ? res.error : '寫入失敗');

      await loadExpenseFromSheet();
      await loadInstallments();

      expDate.value = '';
      expAmount.value = '';
      expNote.value = '';
      expInstallTerms.value = '';
      expPerTerm.value = '';

      expMsg.textContent = (res.terms && res.terms > 1)
        ? `已新增分期支出：本月扣 ${fmt(res.amount)}，剩餘 ${fmt(res.remainingAmount)}（${res.remainingTerms} 期）`
        : '已新增支出並同步試算表。';

      setSummaryMonthIfEmpty(monthOfDate(date));
      autoRecalc();
    } catch (e) {
      expMsg.textContent = '寫入失敗：' + e.message;
      expMsg.classList.add('error');
    }
  });

  async function loadExpenseFromSheet(){
    expMsg.classList.remove('error');
    expMsg.textContent = '讀取支出中...';
    try{
      const res = await jsonpGet({ type:'listExpense' });
      if (!res || !res.success) throw new Error((res && res.error) ? res.error : '讀取失敗');

      expenses = (res.data || []).map(x => ({
        recordId: x.recordId,
        date: x.date,
        month: x.month,
        amount: Number(x.amount||0),
        note: x.note || '',
        kind: x.kind || 'normal',
        terms: Number(x.terms||0)
      }));
      renderExpenseTable();
      expMsg.textContent = `已讀取 ${expenses.length} 筆支出。`;
    }catch(e){
      expMsg.textContent = '讀取失敗：' + e.message;
      expMsg.classList.add('error');
    }
  }

  function renderExpenseTable() {
    expTableBody.innerHTML = '';
    expenses.forEach(item => {
      const kindLabel = (item.kind === 'installment') ? '分期' : '一般';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ymdToDisplay(item.date)}</td>
        <td>${fmt(item.amount)}</td>
        <td>${item.note || ''}</td>
        <td>${kindLabel}</td>
        <td>
          <button class="btn-small exp-edit" data-id="${item.recordId}">編輯</button>
          <button class="btn-small exp-del" data-id="${item.recordId}">刪除</button>
        </td>
      `;
      expTableBody.appendChild(tr);
    });

    expTableBody.querySelectorAll('.exp-edit').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id;
        const item = expenses.find(x => x.recordId === id);
        if (!item) return;

        editingExpenseRecordId = id;
        expDate.value = item.date;
        expAmount.value = String(item.amount);
        expNote.value = item.note || '';

        // 編輯時不改分期欄位
        expInstallTerms.value = '';
        expPerTerm.value = '';
        document.getElementById('addExpenseBtn').textContent = '更新支出';
        cancelExpenseEditBtn.style.display = 'inline-block';

        expMsg.textContent = '編輯模式：只會更新日期/金額/備註（分期資料不建議在此修改）。';
        expMsg.classList.remove('error');

        setSummaryMonthIfEmpty(item.month);
      });
    });

    expTableBody.querySelectorAll('.exp-del').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        if (!confirm('確定要刪除此筆支出，並同步刪除試算表資料嗎？')) return;

        expMsg.classList.remove('error');
        expMsg.textContent = '刪除中...';

        try {
          const res = await jsonpGet({ type: 'deleteExpense', recordId: id });
          if (!res || !res.success) throw new Error((res && res.error) ? res.error : '刪除失敗');
          await loadExpenseFromSheet();
          expMsg.textContent = '已同步刪除試算表資料。';
          autoRecalc();
        } catch (e) {
          expMsg.textContent = '刪除失敗：' + e.message;
          expMsg.classList.add('error');
        }
      });
    });
  }

  // 分期清單顯示
  const installTableBody = document.getElementById('installTableBody');
  const installMsg = document.getElementById('installMsg');
  document.getElementById('reloadInstallBtn').addEventListener('click', loadInstallments);

  async function loadInstallments(){
    installMsg.classList.remove('error');
    installMsg.textContent = '讀取分期清單中...';
    try{
      const res = await jsonpGet({ type:'listInstallments' });
      if (!res || !res.success) throw new Error((res && res.error) ? res.error : '讀取失敗');

      const list = res.data || [];
      installTableBody.innerHTML = '';
      list.forEach(x=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.note || ''}</td>
          <td>${fmt(x.totalAmount)}</td>
          <td>${fmt(x.perTerm)}</td>
          <td>${fmt(x.remainingAmount)}</td>
          <td>${x.remainingTerms}</td>
          <td>${x.active ? '進行中' : '已結束'}</td>
        `;
        installTableBody.appendChild(tr);
      });
      installMsg.textContent = `已讀取 ${list.length} 筆分期。`;
    }catch(e){
      installMsg.textContent = '讀取分期清單失敗：' + e.message;
      installMsg.classList.add('error');
    }
  }

  // =========================================================
  // 固定支出：其他固定支出 + 訂閱（維持原流程）
  // =========================================================
  const otherFixedAmount = document.getElementById('otherFixedAmount');
  const otherFixedMsg = document.getElementById('otherFixedMsg');

  document.getElementById('saveOtherFixedBtn').addEventListener('click', async ()=>{
    const v = Number(otherFixedAmount.value)||0;
    otherFixedMsg.classList.remove('error');
    otherFixedMsg.textContent = '儲存中...';
    try{
      const res = await jsonpGet({ type:'saveSettings', otherFixed: String(v) });
      if (!res || !res.success) throw new Error((res && res.error) ? res.error : '儲存失敗');
      otherFixedMsg.textContent = '已儲存固定支出設定。';
      autoRecalc();
    }catch(e){
      otherFixedMsg.textContent = '儲存失敗：' + e.message;
      otherFixedMsg.classList.add('error');
    }
  });

  async function loadSettings(){
    try{
      const res = await jsonpGet({ type:'getSettings' });
      if (res && res.success && res.data){
        otherFixedAmount.value = String(Number(res.data.otherFixed)||0);
      }
    }catch(_){}
  }

  // 訂閱（維持你原本 OK 的功能）
  let subscriptions = [];
  let editingSubId = null;

  const subNameInput = document.getElementById('subName');
  const subAmountInput = document.getElementById('subAmount');
  const subActiveInput = document.getElementById('subActive');
  const subMsgDiv = document.getElementById('subMsg');
  const subTableBody = document.getElementById('subTableBody');

  async function loadSubscriptionsFromSheet() {
    try {
      subMsgDiv.textContent = '讀取訂閱清單中...';
      subMsgDiv.classList.remove('error');

      const data = await jsonpGet({ type: 'listSubscriptions' });
      if (!data || !data.success) throw new Error((data && data.error) ? data.error : '讀取失敗');

      subscriptions = data.data || [];
      renderSubTable();
      subMsgDiv.textContent = `已讀取 ${subscriptions.length} 筆訂閱（來自試算表）。`;
      autoRecalc();
    } catch (err) {
      subMsgDiv.textContent = '讀取訂閱清單失敗：' + err.message;
      subMsgDiv.classList.add('error');
    }
  }

  function clearSubForm() {
    editingSubId = null;
    subNameInput.value = '';
    subAmountInput.value = '';
    subActiveInput.checked = true;
    document.getElementById('saveSubBtn').textContent = '新增訂閱';
  }

  document.getElementById('clearSubFormBtn').addEventListener('click', () => {
    clearSubForm();
    subMsgDiv.textContent = '';
    subMsgDiv.classList.remove('error');
  });

  document.getElementById('reloadSubBtn').addEventListener('click', loadSubscriptionsFromSheet);

  document.getElementById('saveSubBtn').addEventListener('click', async () => {
    const name = subNameInput.value.trim();
    const amount = Number(subAmountInput.value) || 0;
    const active = subActiveInput.checked;

    if (!name || !amount) {
      subMsgDiv.textContent = '請輸入訂閱名稱與月費';
      subMsgDiv.classList.add('error');
      return;
    }

    let id = editingSubId;
    if (!id) id = 'sub_' + Date.now() + '_' + Math.floor(Math.random() * 100000);

    subMsgDiv.textContent = '已送出寫入（請稍候刷新清單）...';
    subMsgDiv.classList.remove('error');

    postForm({
      type: 'saveSubscription',
      id,
      name,
      amount: String(amount),
      active: active ? 'true' : 'false'
    });

    setTimeout(async () => {
      await loadSubscriptionsFromSheet();
      clearSubForm();
    }, 800);
  });

  function renderSubTable() {
    subTableBody.innerHTML = '';
    subscriptions.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.name}</td>
        <td>${fmt(s.amount)}</td>
        <td><input type="checkbox" data-id="${s.id}" class="sub-active-toggle" ${s.active ? 'checked' : ''}></td>
        <td>
          <button class="btn-small sub-edit" data-id="${s.id}">編輯</button>
          <button class="btn-small sub-del" data-id="${s.id}">刪除</button>
        </td>
      `;
      subTableBody.appendChild(tr);
    });

    subTableBody.querySelectorAll('.sub-active-toggle').forEach(cb => {
      cb.addEventListener('change', () => {
        const id = cb.dataset.id;
        const s = subscriptions.find(x => x.id === id);
        if (!s) return;
        s.active = cb.checked;
        postForm({
          type: 'saveSubscription',
          id: s.id,
          name: s.name,
          amount: String(s.amount),
          active: s.active ? 'true' : 'false'
        });
        setTimeout(autoRecalc, 500);
      });
    });

    subTableBody.querySelectorAll('.sub-edit').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const s = subscriptions.find(x => x.id === id);
        if (!s) return;
        editingSubId = id;
        subNameInput.value = s.name;
        subAmountInput.value = s.amount;
        subActiveInput.checked = s.active;
        document.getElementById('saveSubBtn').textContent = '更新訂閱';
        subMsgDiv.textContent = '編輯模式：修改後按「更新訂閱」';
        subMsgDiv.classList.remove('error');
      });
    });

    subTableBody.querySelectorAll('.sub-del').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        if (!confirm('確定要刪除這筆訂閱嗎？')) return;

        subMsgDiv.textContent = '已送出刪除（請稍候刷新清單）...';
        subMsgDiv.classList.remove('error');

        postForm({ type: 'deleteSubscription', id });

        setTimeout(async () => {
          await loadSubscriptionsFromSheet();
        }, 800);
      });
    });
  }

  // =========================================================
  // 總計：自動更新 + 手動重算 + 存檔彙總
  // =========================================================
  const summaryMonth = document.getElementById('summaryMonth');
  const sumMsg = document.getElementById('sumMsg');
  const sumDetail = document.getElementById('sumDetail');

  const kIncome = document.getElementById('kIncome');
  const kExpense = document.getElementById('kExpense');
  const kInstall = document.getElementById('kInstall');
  const kFixed = document.getElementById('kFixed');
  const kRemain = document.getElementById('kRemain');

  document.getElementById('recalcBtn').addEventListener('click', recalc);
  document.getElementById('saveMonthlySummaryBtn').addEventListener('click', saveMonthlySummary);

  summaryMonth.addEventListener('change', ()=> autoRecalc(true));

  function ensureSummaryMonth(){
    if (!summaryMonth.value) {
      const d = new Date();
      summaryMonth.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }
  }

  function setSummaryMonthIfEmpty(m){
    if (!m) return;
    if (!summaryMonth.value) summaryMonth.value = m;
  }

  let recalcTimer = null;
  function autoRecalc(force){
    // 只有在總計頁 or force 才跑
    const summaryTabActive = document.getElementById('tab-summary').classList.contains('active');
    if (!summaryTabActive && !force) return;

    ensureSummaryMonth();
    clearTimeout(recalcTimer);
    recalcTimer = setTimeout(recalc, 250);
  }

  async function recalc(){
    const m = summaryMonth.value; // yyyy-mm
    sumMsg.classList.remove('error');
    if (!m){
      sumMsg.textContent = '請選擇月份';
      sumMsg.classList.add('error');
      return;
    }
    sumMsg.textContent = '計算中...';

    try{
      const res = await jsonpGet({ type:'getMonthlySummary', month: m });
      if (!res || !res.success) throw new Error((res && res.error) ? res.error : '計算失敗');

      kIncome.textContent  = fmt(res.data.incomeTotal);
      kExpense.textContent = fmt(res.data.expenseTotal);
      kInstall.textContent = fmt(res.data.installmentCharge);
      kFixed.textContent   = fmt(res.data.fixedTotal);
      kRemain.textContent  = fmt(res.data.remain);

      sumDetail.innerHTML = `
        <div class="hint">
          <b>${m}</b><br/>
          訂閱明細：${(res.data.subDetail || '（無）')}<br/>
          其他固定支出：${fmt(res.data.otherFixed)}<br/>
          訂閱合計：${fmt(res.data.subTotal)}<br/>
          固定支出合計：${fmt(res.data.fixedTotal)}<br/>
        </div>
      `;
      sumMsg.textContent = '計算完成（自動更新）。';
    }catch(e){
      sumMsg.textContent = '計算失敗：' + e.message;
      sumMsg.classList.add('error');
    }
  }

  async function saveMonthlySummary(){
    const m = summaryMonth.value;
    sumMsg.classList.remove('error');
    if (!m){
      sumMsg.textContent = '請先選擇月份';
      sumMsg.classList.add('error');
      return;
    }
    if (!confirm(`確定要將 ${m} 的彙總存到試算表「流水」嗎？（會新增/更新一列）\n注意：這會套用當月分期扣款，避免重複扣款。`)) return;

    sumMsg.textContent = '存檔中...';
    try{
      const res = await jsonpGet({ type:'saveMonthlySummary', month: m });
      if (!res || !res.success) throw new Error((res && res.error) ? res.error : '存檔失敗');
      sumMsg.textContent = `已存檔（彙總列：${res.rowNumber}）。`;
      // 存檔後再重算一次（因為分期扣款可能新增了一筆當月支出）
      autoRecalc(true);
      await loadExpenseFromSheet();
      await loadInstallments();
    }catch(e){
      sumMsg.textContent = '存檔失敗：' + e.message;
      sumMsg.classList.add('error');
    }
  }

  // =========================================================
  // 初始化
  // =========================================================
  (async function init(){
    // 預設月份
    ensureSummaryMonth();

    // 先讀取三塊：收入/支出/分期 + 設定 + 訂閱
    await loadIncomeFromSheet();
    await loadExpenseFromSheet();
    await loadInstallments();
    await loadSettings();
    await loadSubscriptionsFromSheet();

    // 讓總計初次就有值（但不會強迫你切到總計頁）
    autoRecalc(true);
  })();
</script>
</body>
</html>
